<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">

  <xacro:macro name="iiwa" params="parent prefix *origin">

  <material name="${prefix}gray">
    <color rgba="0.5 0.5 0.5 1.0"/>
  </material>

  <link name="${prefix}iiwa_base" type="fixed"/>

  <joint name="${prefix}iiwa_root_joint" type="fixed">
      <xacro:insert_block name="origin" />
      <parent link="${parent}"/>
      <child link="${prefix}iiwa_base"/>
  </joint>

  <joint name="${prefix}iiwa_base_joint" type="fixed">
      <origin rpy="0.0 0 0" xyz="0 0 0"/>
      <parent link="${prefix}iiwa_base"/>
      <child link="${prefix}link_0"/>
  </joint>

  <link name="${prefix}link_0">
      <visual><origin rpy="0.0 0 0" xyz="0 0 0"/><geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/visual/base_link.dae"/></geometry></visual>
      <collision><origin rpy="0 0 0" xyz="0 0 0"/><geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/collision/base_link.stl"/></geometry></collision>
      <inertial><origin xyz="-0.1 0 0.07" rpy="0 0 0"/><mass value="5"/><inertia ixx="0.05" ixy="0" ixz="0" iyy="0.06" iyz="0" izz="0.03" /></inertial>
  </link>
  <link name="${prefix}link_1">
      <visual><origin rpy="0 0 0" xyz="0 0 0"/><geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/visual/link_1.dae"/></geometry></visual>
      <collision><origin rpy="0 0 0" xyz="0 0 0"/><geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/collision/link_1.stl"/></geometry></collision>
      <inertial><origin xyz="0 -0.03 0.12" rpy="0 0 0"/><mass value="4"/><inertia ixx="0.1" ixy="0" ixz="0" iyy="0.09" iyz="0" izz="0.02" /></inertial>
  </link>
  <link name="${prefix}link_2">
      <visual><origin rpy="0 0 0" xyz="0 0 0"/><geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/visual/link_2.dae"/></geometry></visual>
      <collision><origin rpy="0 0 0" xyz="0 0 0"/><geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/collision/link_2.stl"/></geometry></collision>
      <inertial><origin xyz="0.0003 0.059 0.042" rpy="0 0 0"/><mass value="4"/><inertia ixx="0.05" ixy="0" ixz="0" iyy="0.018" iyz="0" izz="0.044" /></inertial>
  </link>
  <link name="${prefix}link_3">
      <visual><origin rpy="0 0 0" xyz="0 0 0"/><geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/visual/link_3.dae"/></geometry></visual>
      <collision><origin rpy="0 0 0" xyz="0 0 0"/><geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/collision/link_3.stl"/></geometry></collision>
      <inertial><origin xyz="0 0.03 0.13" rpy="0 0 0"/><mass value="3"/><inertia ixx="0.08" ixy="0" ixz="0" iyy="0.075" iyz="0" izz="0.01" /></inertial>
  </link>
  <link name="${prefix}link_4">
      <visual><origin rpy="0 0 0" xyz="0 0 0"/><geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/visual/link_4.dae"/></geometry></visual>
      <collision><origin rpy="0 0 0" xyz="0 0 0"/><geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/collision/link_4.stl"/></geometry></collision>
      <inertial><origin xyz="0 0.067 0.034" rpy="0 0 0"/><mass value="2.7"/><inertia ixx="0.03" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.029" /></inertial>
  </link>
  <link name="${prefix}link_5">
      <visual><origin rpy="0 0 0" xyz="0 0 0"/><geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/visual/link_5.dae"/></geometry></visual>
      <collision><origin rpy="0 0 0" xyz="0 0 0"/><geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/collision/link_5.stl"/></geometry></collision>
      <inertial><origin xyz="0.0001 0.021 0.076" rpy="0 0 0"/><mass value="1.7"/><inertia ixx="0.02" ixy="0" ixz="0" iyy="0.018" iyz="0" izz="0.005" /></inertial>
  </link>
  <link name="${prefix}link_6">
      <visual><origin rpy="0 0 0" xyz="0 0 0"/><geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/visual/link_6.dae"/></geometry></visual>
      <collision><origin rpy="0 0 0" xyz="0 0 0"/><geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/collision/link_6.stl"/></geometry></collision>
      <inertial><origin xyz="0 0.0006 0.0004" rpy="0 0 0"/><mass value="1.8"/><inertia ixx="0.025" ixy="0" ixz="0" iyy="0.0136" iyz="0" izz="0.0247" /></inertial>
  </link>
  <link name="${prefix}link_7">
      <visual><origin rpy="0 0 0" xyz="0 0 0.07"/><material name="${prefix}gray"/><geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/visual/link_7_2.stl" scale ="0.001 0.001 0.001"/></geometry></visual>
      <collision><origin rpy="0 0 0" xyz="0 0 0.07"/><geometry><mesh filename="file://$(find iiwa_description)/meshes/lbr_iiwa_14_r820/collision/link_7_2.stl" scale ="0.001 0.001 0.001"/></geometry></collision>
      <inertial><origin xyz="0 0 0.02" rpy="0 0 0"/><mass value="${0.3 / 0.308 * 0.44}"/><inertia ixx="0.01" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.01" /></inertial>
  </link>

  <link name="${prefix}tool0"/>

  <joint name="${prefix}joint_a1" type="revolute"><origin rpy="0 0 0" xyz="0 0 0"/><parent link="${prefix}link_0"/><child link="${prefix}link_1"/><axis xyz="0 0 1"/><limit effort="320" lower="-2.9668" upper="2.9668" velocity="1.4834"/></joint>
  <joint name="${prefix}joint_a2" type="revolute"><origin rpy="0 0 0" xyz="-0.00043624 0 0.36"/><parent link="${prefix}link_1"/><child link="${prefix}link_2"/><axis xyz="0 1 0"/><limit effort="320" lower="-2.0942" upper="2.0942" velocity="1.4834"/></joint>
  <joint name="${prefix}joint_a3" type="revolute"><origin rpy="0 0 0" xyz="0 0 0"/><parent link="${prefix}link_2"/><child link="${prefix}link_3"/><axis xyz="0 0 1"/><limit effort="176" lower="-2.9668" upper="2.9668" velocity="1.7452"/></joint>
  <joint name="${prefix}joint_a4" type="revolute"><origin rpy="0 0 0" xyz="0.00043624 0 0.42"/><parent link="${prefix}link_3"/><child link="${prefix}link_4"/><axis xyz="0 -1 0"/><limit effort="176" lower="-2.0942" upper="2.0942" velocity="1.3089"/></joint>
  <joint name="${prefix}joint_a5" type="revolute"><origin rpy="0 0 0" xyz="0 0 0"/><parent link="${prefix}link_4"/><child link="${prefix}link_5"/><axis xyz="0 0 1"/><limit effort="110" lower="-2.9668" upper="2.9668" velocity="2.2688"/></joint>
  <joint name="${prefix}joint_a6" type="revolute"><origin rpy="0 0 0" xyz="0 0 0.4"/><parent link="${prefix}link_5"/><child link="${prefix}link_6"/><axis xyz="0 1 0"/><limit effort="40" lower="-2.0942" upper="2.0942" velocity="2.356"/></joint>
  <joint name="${prefix}joint_a7" type="revolute"><origin rpy="0 0 0" xyz="0 0 0"/><parent link="${prefix}link_6"/><child link="${prefix}link_7"/><axis xyz="0 0 1"/><limit effort="40" lower="-3.0541" upper="3.0541" velocity="2.356"/></joint>
  <joint name="${prefix}joint_a7-tool0" type="fixed"><origin rpy="0 0 0" xyz="0 0 0.154"/><parent link="${prefix}link_7"/><child link="${prefix}tool0"/><axis xyz="0 0 0"/></joint>

  <joint name="${prefix}adapter_joint" type="fixed"><origin rpy="0 0 0" xyz="0 0 0.015"/><parent link="${prefix}tool0"/><child link="${prefix}gripper_adapter_link"/></joint>
  <link name="${prefix}gripper_adapter_link">
    <visual><origin rpy="0 0 0" xyz="0 0 0"/><geometry><cylinder radius="0.03" length="0.03"/></geometry><material name="${prefix}gray"/></visual>
    <collision><origin rpy="0 0 0" xyz="0 0 0"/><geometry><cylinder radius="0.03" length="0.03"/></geometry></collision>
    <inertial><mass value="0.05"/><inertia ixx="0.000015" ixy="0" ixz="0" iyy="0.000015" iyz="0" izz="0.000022"/></inertial>
  </link>

  <joint name="${prefix}gripper_base_joint" type="fixed"><origin rpy="0 0 0" xyz="0 0 0.015"/><parent link="${prefix}gripper_adapter_link"/><child link="${prefix}gripper_base_link"/></joint>

  <link name="${prefix}gripper_base_link">
      <visual><origin rpy="0 0 0" xyz="0 0 0"/><geometry><mesh filename="file://$(find iiwa_description)/meshes/grabber/the_crawer_base.stl" scale="0.0018 0.0018 0.0018"/></geometry><material name="${prefix}gray"/></visual>
      <collision><origin rpy="0 0 0" xyz="0 0 0"/><geometry><box size="0.063 0.09 0.036"/></geometry></collision>
      <inertial><mass value="0.15"/><inertia ixx="6.9e-05" ixy="0.0" ixz="0.0" iyy="1.2e-04" iyz="0.0" izz="1.0e-04"/></inertial>
  </link>

  <joint name="${prefix}finger_left_joint" type="prismatic">
    <parent link="${prefix}gripper_base_link"/>
    <child link="${prefix}crawer_left"/>
    <origin xyz="-0.06 0.0 0.018" rpy="0 -1.57 0"/>
    <axis xyz="0 0 1"/>
    <limit effort="100" lower="-0.05" upper="0.06" velocity="0.5"/>
    </joint>

  <link name="${prefix}crawer_left">
    <visual>
        <origin rpy="0 0 0" xyz="0 0 0"/>
        <geometry><mesh filename="file://$(find iiwa_description)/meshes/grabber/the_crawer.stl" scale="0.0018 0.0018 0.0018"/></geometry>
        <material name="${prefix}gray"/>
    </visual>
    <collision>
        <origin rpy="0 0 0" xyz="0 0 0"/>
        <geometry><mesh filename="file://$(find iiwa_description)/meshes/grabber/the_crawer.stl" scale="0.0018 0.0018 0.0018"/></geometry>
    </collision>
    <inertial><mass value="0.1"/><inertia ixx="6.9e-05" ixy="0.0" ixz="0.0" iyy="1.2e-04" iyz="0.0" izz="1.0e-04"/></inertial>
  </link>

  <joint name="${prefix}finger_right_joint" type="prismatic">
    <parent link="${prefix}gripper_base_link"/>
    <child link="${prefix}crawer_right"/>
    <origin xyz="0.06 0.0 0.018" rpy="3.1415 -1.57 0"/>
    <axis xyz="0 0 1"/>
    <limit effort="100" lower="-0.05" upper="0.06" velocity="0.5"/>
  </joint>
    
  <link name="${prefix}crawer_right">
    <visual>
        <origin rpy="0 0 0" xyz="0 0 0"/>
        <geometry><mesh filename="file://$(find iiwa_description)/meshes/grabber/the_crawer.stl" scale="0.0018 0.0018 0.0018"/></geometry>
        <material name="${prefix}gray"/>
    </visual>
    <collision>
        <origin rpy="0 0 0" xyz="0 0 0"/>
        <geometry><mesh filename="file://$(find iiwa_description)/meshes/grabber/the_crawer.stl" scale="0.0018 0.0018 0.0018"/></geometry>
    </collision>
    <inertial><mass value="0.1"/><inertia ixx="6.9e-05" ixy="0.0" ixz="0.0" iyy="1.2e-04" iyz="0.0" izz="1.0e-04"/></inertial>
  </link>

  <gazebo reference="${prefix}crawer_left">
    <material>Gazebo/Grey</material>
    <mu1>1000.0</mu1>
    <mu2>1000.0</mu2>
    <kp>1000000.0</kp>
    <kd>1.0</kd>
    <minDepth>0.001</minDepth>
    <maxVel>0.0</maxVel>
  </gazebo>

  <gazebo reference="${prefix}crawer_right">
    <material>Gazebo/Grey</material>
    <mu1>1000.0</mu1>
    <mu2>1000.0</mu2>
    <kp>1000000.0</kp>
    <kd>1.0</kd>
    <minDepth>0.001</minDepth>
    <maxVel>0.0</maxVel>
  </gazebo>

  <gazebo reference="${prefix}gripper_base_link"><material>Gazebo/Grey</material></gazebo>
  <gazebo reference="${prefix}gripper_adapter_link"><material>Gazebo/Grey</material></gazebo>

  <joint name="${prefix}camera_joint" type="fixed"><parent link="${prefix}tool0"/><child link="${prefix}camera_link"/><origin xyz="0 0 0" rpy="3.14 -1.57 0"/></joint>
  <link name="${prefix}camera_link"><visual><geometry><box size="0.01 0.01 0.01"/></geometry></visual><inertial><mass value="0.01"/><inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.0001" iyz="0" izz="0.0001"/></inertial></link>
  <joint name="${prefix}camera_optical_joint" type="fixed"><origin xyz="0 0 0" rpy="-1.5708 0 -1.5708"/><parent link="${prefix}camera_link"/><child link="${prefix}camera_link_optical"/></joint>
  <link name="${prefix}camera_link_optical"/>    
  <gazebo reference="${prefix}camera_link">
    <sensor name="${prefix}camera" type="camera">
      <camera><horizontal_fov>1.57</horizontal_fov><image><width>1920</width><height>1080</height><format>R8G8B8</format></image><clip><near>0.1</near><far>100</far></clip></camera>
      <always_on>1</always_on><update_rate>30</update_rate><visualize>true</visualize><topic>${prefix}camera/image_raw</topic><ignition_frame_id>${prefix}camera_link_optical</ignition_frame_id>
    </sensor>
  </gazebo>
    
  <ros2_control name="${prefix}IgnitionSystem" type="system">
    <hardware><plugin>ign_ros2_control/IgnitionSystem</plugin></hardware>
    <joint name="${prefix}joint_a1"><command_interface name="position"/><command_interface name="velocity"/><state_interface name="position"/><state_interface name="velocity"/><state_interface name="effort"/></joint>
    <joint name="${prefix}joint_a2"><command_interface name="position"/><command_interface name="velocity"/><state_interface name="position"/><state_interface name="velocity"/><state_interface name="effort"/></joint>
    <joint name="${prefix}joint_a3"><command_interface name="position"/><command_interface name="velocity"/><state_interface name="position"/><state_interface name="velocity"/><state_interface name="effort"/></joint>
    <joint name="${prefix}joint_a4"><command_interface name="position"/><command_interface name="velocity"/><state_interface name="position"/><state_interface name="velocity"/><state_interface name="effort"/></joint>
    <joint name="${prefix}joint_a5"><command_interface name="position"/><command_interface name="velocity"/><state_interface name="position"/><state_interface name="velocity"/><state_interface name="effort"/></joint>
    <joint name="${prefix}joint_a6"><command_interface name="position"/><command_interface name="velocity"/><state_interface name="position"/><state_interface name="velocity"/><state_interface name="effort"/></joint>
    <joint name="${prefix}joint_a7"><command_interface name="position"/><command_interface name="velocity"/><state_interface name="position"/><state_interface name="velocity"/><state_interface name="effort"/></joint>
    
    <joint name="${prefix}finger_left_joint">
      <command_interface name="position"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
    <joint name="${prefix}finger_right_joint">
      <command_interface name="position"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
  </ros2_control>

  </xacro:macro>
</robot>
